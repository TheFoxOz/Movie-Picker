<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie Picker</title>
    
    <!-- PWA Manifest & Theme: This path is now relative to the root, matching the fix. -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#f97316">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Movie Picker">

    <!-- Load Tailwind + Confetti -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.js"></script>
    
    <!-- FIREBASE MODULE IMPORTS -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"; // Optional: Use for debugging

        // Access global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-movie-picker-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        let userId = null;
        let isAuthReady = false;

        // Function to initialize Firebase and authenticate
        async function setupFirebase() {
            try {
                // setLogLevel('debug'); // Uncomment to see Firebase logs
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // 1. Listen for auth state changes
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        window.userId = user.uid; // Make userId available globally
                        window.db = db; // Make db available globally
                        window.isAuthReady = true; // Flag for content loading
                        if (!isAuthReady) {
                             window.initializeAppContent(); // Run app initialization once ready
                        }
                    } else {
                        // If auth fails or user signs out, we still get an ID (anonymous/random)
                        window.userId = 'guest-' + crypto.randomUUID().substring(0, 8);
                        window.db = db; 
                        window.isAuthReady = true;
                        if (!isAuthReady) {
                             window.initializeAppContent(); // Run app initialization
                        }
                    }
                });

                // 2. Perform initial sign-in
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase Initialization or Auth Failed:", error);
                // Fallback to anonymous ID if auth fails completely
                window.userId = 'guest-fail-' + crypto.randomUUID().substring(0, 8);
                window.isAuthReady = true;
                window.initializeAppContent();
            }
        }
        
        // Expose Firebase components to the main script block
        window.setupFirebase = setupFirebase;
        window.db = db; 
        window.userId = userId;
        window.isAuthReady = isAuthReady;
        window.setDoc = setDoc;
        window.doc = doc;
        window.serverTimestamp = serverTimestamp;
        window.appId = appId;
    </script>
    
    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#f97316',
                        'secondary': '#1f2937',
                        'card-bg': '#374151',
                        'success': '#10b981',
                        'nope': '#ef4444',
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                }
            }
        }
    </script>
    <style>
        /* General Styles */
        body { background-color: #111827; color: #f3f4f6; font-family: 'Inter', sans-serif; }
        .app-container { max-width: 420px; margin: 0 auto; min-height: 100dvh; display: flex; flex-direction: column; box-shadow: 0 0 25px rgba(0,0,0,0.5); background-color: #1f2937; }
        
        /* Layout */
        .tab-content { flex-grow: 1; overflow-y: auto; padding-bottom: 72px; }
        .nav-bar { position: fixed; bottom: 0; left: 0; right: 0; max-width: 420px; margin: 0 auto; background-color: #111827; border-top: 1px solid #374151; height: 64px; z-index: 20; }
        .nav-item.active { color: var(--primary-color); }
        
        /* Swipe Card */
        .swipe-card { width: 100%; max-width: 380px; height: 550px; margin: 0 auto; position: relative; overflow: hidden; background-color: #374151; transition: transform 0.3s ease-out, opacity 0.3s ease-out; cursor: grab; touch-action: none; will-change: transform; }
        .swipe-card-poster { height: 60%; position: relative; }
        .swipe-card-details { height: 40%; overflow-y: auto; }

        /* Overlays */
        .swipe-overlay { position: absolute; top: 20px; z-index: 10; padding: 8px 16px; border-radius: 8px; font-size: 32px; font-weight: 800; text-transform: uppercase; letter-spacing: 2px; opacity: 0; transform: scale(0.8) rotate(0deg); transition: opacity 0.1s, transform 0.1s; }
        .overlay-like { border: 5px solid #10b981; color: #10b981; left: 20px; transform: rotate(-25deg); }
        .overlay-nope { border: 5px solid #ef4444; color: #ef4444; right: 20px; transform: rotate(25deg); }
        .action-button { transition: all 0.1s ease-in-out; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .action-button:active { transform: scale(0.95); }
        #undo-toast { bottom: 80px; transition: transform 0.3s ease-out; }
        
        /* Toggle Switch (for Profile) */
        .toggle-switch { position: relative; display: inline-block; width: 48px; height: 24px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #4b5563; transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #f97316; }
        input:checked + .slider:before { transform: translateX(24px); }

    </style>
</head>
<body class="bg-gray-900">
    <div class="app-container">
        
        <!-- Main Content Area -->
        <div id="content-area" class="tab-content">
            <!-- Loading state before Firebase is ready -->
            <div id="loading-spinner" class="flex flex-col items-center justify-center min-h-[500px] p-8">
                <svg class="animate-spin h-10 w-10 text-primary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="text-gray-400 mt-4">Initializing application...</p>
            </div>
        </div>

        <!-- Fixed Bottom Navigation Bar -->
        <div id="nav-bar" class="nav-bar flex justify-around items-center">
            
            <!-- Watchlist Tab Button -->
            <button class="nav-item flex flex-col items-center p-2 text-gray-400 hover:text-primary transition" data-tab="watchlist" aria-label="Go to Watchlist">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M17.593 3.322c1.1.128 1.907 1.077 1.907 2.185V21L12 17.25 4.5 21V5.507c0-1.108.806-2.057 1.907-2.185a48.507 48.507 0 0111.186 0z" />
                </svg>
                <span class="text-xs">Watchlist</span>
            </button>

            <!-- Swipe Tab Button (Active Default) -->
            <button class="nav-item flex flex-col items-center p-2 text-primary active transition" data-tab="swipe" aria-label="Start swiping for new movies">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M7.5 7.5l7.5 7.5m0-7.5l-7.5 7.5M10.5 6a7.5 7.5 0 100 15 7.5 7.5 0 000-15z" />
                </svg>
                <span class="text-xs">Swipe</span>
            </button>

            <!-- Matches Tab Button -->
            <button class="nav-item flex flex-col items-center p-2 text-gray-400 hover:text-primary transition" data-tab="matches" aria-label="View group and couple matches">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.054-4.312 2.655-.715-1.601-2.377-2.655-4.313-2.655C4.099 3.75 2 5.765 2 8.25c0 7.22 9 12 10 12s10-4.78 10-12z" />
                </svg>
                <span class="text-xs">Matches</span>
            </button>

            <!-- Profile/Settings Tab Button -->
            <button class="nav-item flex flex-col items-center p-2 text-gray-400 hover:text-primary transition" data-tab="profile" aria-label="View profile and settings">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 19.5a2.25 2.25 0 01-1.8-2.25v-.75a1.5 1.5 0 011.5-1.5h16.5a1.5 1.5 0 011.5 1.5v.75a2.25 2.25 0 01-1.8 2.25H4.501z" />
                </svg>
                <span class="text-xs">Profile</span>
            </button>
        </div>

    </div>
    <script>
        // --- Global Firebase References (Set in the module script) ---
        // window.db, window.userId, window.isAuthReady, window.setDoc, window.doc, window.serverTimestamp, window.appId
        
        // --- Mock Data ---
        const MOCK_WARNING_SETTINGS = [
            { label: "High Violence / Gore", enabled: true },
            { label: "Needles / Injections", enabled: false },
            { label: "Jump Scares", enabled: true },
        ];
        
        const MOCK_PLATFORMS = [
            { name: "Netflix", status: "Connected", icon: "N", color: "text-red-600" },
            { name: "Hulu", status: "Connected", icon: "H", color: "text-green-500" },
            { name: "Max (HBO)", status: "Disconnected", icon: "M", color: "text-blue-500" },
        ];

        const MOCK_GROUP_DATA = {
            // Updated one match to 100% to demonstrate confetti
            "Alex K. & Sarah J.": [
                { movie: "Interstellar Journey", likes: ["Alex K.", "Sarah J."], totalMembers: 2, platform: "Netflix" },
                { movie: "Perfect Match Movie", likes: ["Alex K.", "Sarah J."], totalMembers: 2, platform: "Hulu" }, 
            ],
            "The Squad (5 Members)": [
                { movie: "Action Protocol 7", likes: ["You", "Tom", "Jess", "Mike"], totalMembers: 5, platform: "Hulu" },
                { movie: "Echo Chamber", likes: ["You", "Tom", "Jess", "Mike", "Alex"], totalMembers: 5, platform: "Max (HBO)" },
            ]
        };

        const MOCK_SWIPE_MOVIES = [
            {
                id: "void-walker-2024", // Changed ID to string for Firestore use
                title: "The Void Walker",
                year: 2024,
                genre: "Sci-Fi / Mystery",
                runtime: "128 min",
                imdb: 8.4,
                rt: 94,
                platform: "Netflix",
                mood: "Mind-blowing, Thrilling",
                matchProb: 92,
                aiSummary: "The AI suggests this movie because you frequently rate high-concept Sci-Fi films and you recently enabled the 'Thrilling' mood filter. It shares narrative DNA with 'Inception' and 'Primer'."
            },
            {
                id: "echoes-2023",
                title: "Echoes of Tomorrow",
                year: 2023,
                genre: "Drama / Romance",
                runtime: "110 min",
                imdb: 7.9,
                rt: 88,
                platform: "Prime Video",
                mood: "Cozy, Feel-good",
                matchProb: 85,
                aiSummary: "This is a perfect 'Feel-good' match for your preference for short-duration, high-rated dramas available on your Prime Video account."
            },
            {
                id: "crystal-king-2022",
                title: "Crystal King",
                year: 2022,
                genre: "Fantasy / Adventure",
                runtime: "145 min",
                imdb: 8.1,
                rt: 90,
                platform: "Hulu",
                mood: "Epic, Visual Spectacle",
                matchProb: 95,
                aiSummary: "Highest rated Fantasy film this year. The platform analysis shows this is available on Hulu, one of your connected services."
            },
            {
                id: "rogue-protocol-2021",
                title: "Rogue Protocol",
                year: 2021,
                genre: "Action / Thriller",
                runtime: "98 min",
                imdb: 7.5,
                rt: 82,
                platform: "Max (HBO)",
                mood: "Fast-paced, Intense",
                matchProb: 88,
                aiSummary: "A quick-hit action thriller that aligns with your low runtime preference. High-octane fun for a weeknight."
            }
        ];
        
        let swipeHistory = []; // To store the history of swipes for undo functionality
        let currentMovieIndex = 0;
        let toastTimeoutId = null; // For the undo toast timer


        // --- New Feature: Confetti Trigger (11/10 joy) ---
        /**
         * Triggers the confetti explosion for the 11/10 joy feature (on 100% group match).
         */
        const triggerConfetti = () => {
            console.log("Confetti triggered!");
            // Confetti explosion from the top center
            confetti({
                particleCount: 200,
                spread: 120,
                gravity: 0.8,
                decay: 0.95,
                scalar: 1.2,
                zIndex: 1000,
                origin: { y: 0.6 }
            });
        };
        // --- End Confetti Trigger ---

        // --- New Feature: Preloading (Zero Lag) ---
        /**
         * Preloads the next movie by ensuring its data is ready (simulated).
         * This prevents lag when moving to the next card.
         */
        function preloadNextMovie() {
            const nextIndex = currentMovieIndex + 1;
            if (nextIndex < MOCK_SWIPE_MOVIES.length) {
                console.log(`Preloading movie data for index ${nextIndex}: ${MOCK_SWIPE_MOVIES[nextIndex].title}`);
                // Simulate network latency (200ms) for data fetching
                return new Promise(resolve => setTimeout(resolve, 200));
            }
            return Promise.resolve();
        }
        // --- End Preloading ---


        // --- Core Swipe Logic ---

        let isDragging = false;
        let startX = 0;
        const SWIPE_THRESHOLD = 100; // Pixels needed to trigger a swipe

        // Function to handle the actual swipe result (called by buttons OR gestures)
        async function handleSwipeAction(action, cardToSwipe = null) {
            if (!window.isAuthReady) {
                showMockNotification("App is still initializing. Please wait.");
                return;
            }
            
            const movie = MOCK_SWIPE_MOVIES[currentMovieIndex];
            const card = cardToSwipe || document.getElementById(`movie-card-${movie.id}`);
            
            if (!movie || !card) return;

            // 1. Save swipe action to Firestore
            try {
                const swipeData = {
                    action: action, // 'like', 'pass', or 'superlike'
                    timestamp: window.serverTimestamp(),
                    movieTitle: movie.title,
                    movieId: movie.id,
                };
                
                // Firestore path: /artifacts/{appId}/users/{userId}/swipes/{movieId}
                const swipeRef = window.doc(window.db, 
                    'artifacts', window.appId, 
                    'users', window.userId, 
                    'swipes', movie.id
                );

                await window.setDoc(swipeRef, swipeData);
                console.log(`Swipe saved: ${action} for ${movie.title}`);
                
            } catch (e) {
                console.error("Error saving swipe to Firestore: ", e);
                showMockNotification("Error saving swipe! Check console.");
            }
            
            // 2. Store action for potential undo
            swipeHistory.push({ index: currentMovieIndex, movie, action });

            // 3. Apply Haptic Feedback
            if (navigator.vibrate) {
                navigator.vibrate(action === 'superlike' ? [50, 50, 50] : [30]);
            }
            
            // 4. Start preloading the next card immediately after swipe starts (ZERO LAG)
            preloadNextMovie();

            // 5. Determine exit transform based on action
            let exitTransform;
            if (action === 'pass') {
                exitTransform = 'translateX(-200vw) rotate(-25deg)'; 
            } else if (action === 'like') {
                exitTransform = 'translateX(200vw) rotate(25deg)';
            } else { // superlike
                exitTransform = 'translateY(-200vw) scale(0.8)';
            }
            
            // 6. Apply exit animation
            card.style.transition = 'transform 0.4s ease-in-out, opacity 0.4s ease-in-out';
            card.style.transform = exitTransform;
            card.style.opacity = 0;

            // 7. Load next card and show toast after animation completes
            setTimeout(() => {
                currentMovieIndex++;
                setActiveTab('swipe'); 
                
                // Show Undo Toast
                showUndoToast(movie.title, action);
            }, 400);
        }
        
        // Function to reverse the last swipe
        window.undoLastSwipe = function() {
            if (swipeHistory.length === 0) return;
            
            // 1. Remove the last action from history
            const lastSwipe = swipeHistory.pop();
            if (!lastSwipe) return;

            // NOTE: For a real app, UNDO would also DELETE the swipe document from Firestore.
            
            // 2. Restore the index
            currentMovieIndex = lastSwipe.index;
            
            // 3. Show a notification and reload the swipe tab
            showMockNotification(`Undo successful! ${lastSwipe.movie.title} is back.`);
            setActiveTab('swipe'); 

            // 4. Clear the undo toast since the action was reversed
            clearTimeout(toastTimeoutId);
            const toast = document.getElementById('undo-toast');
            if (toast) toast.remove();
        }

        // Functions for handling touch/mouse events
        function handleStart(e, card) {
            isDragging = true;
            startX = e.clientX || e.touches[0].clientX;
            // Disable CSS transitions during drag for smooth, immediate feedback
            card.style.transition = 'none';
        }

        function handleMove(e, card) {
            if (!isDragging) return;
            const currentX = e.clientX || e.touches[0].clientX;
            const deltaX = currentX - startX;
            
            // Tilt calculation (max 15 degrees tilt for -300px to 300px range)
            const rotation = (deltaX / 300) * 15; 
            
            // Apply transform
            card.style.transform = `translateX(${deltaX}px) rotate(${rotation}deg)`;

            // Handle Visual Overlays (LIKE/NOPE)
            const overlayLike = card.querySelector('.overlay-like');
            const overlayNope = card.querySelector('.overlay-nope');

            // Apply opacity and rotation based on drag distance
            const opacity = Math.min(Math.abs(deltaX) / SWIPE_THRESHOLD * 2, 1); // Max 1 opacity
            // const rotateFactor = Math.abs(deltaX) / SWIPE_THRESHOLD * 5; // Subtle rotation on overlay

            if (deltaX > 20) { // Dragging right (LIKE)
                overlayLike.style.opacity = opacity;
                overlayLike.style.transform = `rotate(-25deg) scale(${0.8 + 0.2 * opacity})`;
                overlayNope.style.opacity = 0;
            } else if (deltaX < -20) { // Dragging left (NOPE)
                overlayNope.style.opacity = opacity;
                overlayNope.style.transform = `rotate(25deg) scale(${0.8 + 0.2 * opacity})`;
                overlayLike.style.opacity = 0;
            } else { // Near center
                overlayLike.style.opacity = 0;
                overlayNope.style.opacity = 0;
            }
        }

        function handleEnd(e, card) {
            if (!isDragging) return;
            isDragging = false;
            
            // Remove all overlays
            card.querySelectorAll('.swipe-overlay').forEach(overlay => {
                overlay.style.opacity = 0;
                overlay.style.transform = 'scale(0.8) rotate(0deg)';
            });

            // Re-enable CSS transition for snap-back/exit animation
            card.style.transition = 'transform 0.3s ease-out, opacity 0.3s ease-out';
            
            const eventData = e.changedTouches ? e.changedTouches[0] : e;
            const deltaX = (eventData.clientX || eventData.screenX) - startX;

            if (Math.abs(deltaX) > SWIPE_THRESHOLD) {
                // Swipe detected
                const action = deltaX > 0 ? 'like' : 'pass';
                handleSwipeAction(action, card);
            } else {
                // Snap back to center
                card.style.transform = 'translateX(0) rotate(0)';
            }
        }
        
        function setupSwipeGestureListeners(cardId) {
            const card = document.getElementById(cardId);
            if (!card) return;

            // Mouse Listeners (for desktop demo)
            card.addEventListener('mousedown', (e) => handleStart(e, card));
            document.addEventListener('mousemove', (e) => handleMove(e, card));
            document.addEventListener('mouseup', (e) => handleEnd(e, card));
            
            // Cleanup for mouse up outside the card
            document.addEventListener('mouseleave', (e) => {
                if(isDragging) handleEnd(e, card);
            });


            // Touch Listeners (for mobile/touch devices)
            card.addEventListener('touchstart', (e) => { 
                handleStart(e.touches[0], card); 
            }, { passive: true }); 
            
            card.addEventListener('touchmove', (e) => { 
                e.preventDefault(); 
                handleMove(e.touches[0], card); 
            }, { passive: false }); 
            
            card.addEventListener('touchend', (e) => handleEnd(e, card));
            card.addEventListener('touchcancel', (e) => handleEnd(e, card));
        }

        // --- Content Generation Functions ---

        function generateWatchlistContent() {
            return `
                <div class="p-4">
                    <h1 class="text-3xl font-extrabold text-white tracking-tight pt-2 mb-6">My Watchlist</h1>
                    
                    <p class="text-gray-400 mb-6">Movies you've swiped right on or added manually. (${Math.floor(Math.random() * 5) + 8} items)</p>
                    <p class="text-xs text-gray-500 mb-4 p-3 bg-card-bg rounded-lg border border-gray-700">
                        NOTE: This is mock data. In a final version, this list would be loaded from your 'swipes' Firestore collection where action is 'like' or 'superlike'.
                    </p>
                    <!-- Watchlist Items -->
                    <div class="space-y-3">
                        ${['The Void Walker (92% Match)', 'Rogue Protocol (85% Match)', 'Echo Chamber (90% Match)', 'The Crystal King (77% Match)'].map(title => `
                            <div class="flex items-center space-x-4 bg-card-bg p-3 rounded-xl shadow-lg border border-gray-700">
                                <img src="https://placehold.co/80x120/4b5563/f3f4f6?text=Poster" onerror="this.onerror=null;this.src='https://placehold.co/80x120/4b5563/f3f4f6?text=P';" class="w-12 h-18 object-cover rounded-md flex-shrink-0">
                                <div class="flex-grow">
                                    <p class="text-lg font-semibold text-white truncate">${title.split('(')[0].trim()}</p>
                                    <p class="text-sm text-green-400 font-medium">${title.match(/\(([^)]+)\)/)?.[1] || 'Added'}</p>
                                </div>
                                <button class="text-red-500 hover:text-red-400 transition" aria-label="Remove movie from watchlist">
                                    <!-- Trash Icon for Removal -->
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.2 9m.358-4.5h5.5l-1.09-3.41-5.5 3.41zM21 6l-1.77 15.932A2 2 0 0117.29 23H6.71a2 2 0 01-1.94-2.068L3 6h18z" />
                                    </svg>
                                </button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function getSwipeCardHtml(movie) {
            let platformIcon, platformColor;
            switch(movie.platform) {
                case 'Netflix': platformIcon = 'N'; platformColor = 'bg-red-600'; break;
                case 'Prime Video': platformIcon = 'P'; platformColor = 'bg-sky-400'; break;
                case 'Hulu': platformIcon = 'H'; platformColor = 'bg-green-500'; break;
                case 'Max (HBO)': platformIcon = 'M'; platformColor = 'bg-blue-500'; break;
                default: platformIcon = '?'; platformColor = 'bg-gray-500';
            }

            return `
                <div id="movie-card-${movie.id}" class="swipe-card rounded-2xl shadow-2xl mb-8">
                    
                    <!-- Overlay Stamps (LIKE/NOPE) -->
                    <div class="swipe-overlay overlay-like -rotate-12 absolute z-10 top-10 left-6 text-success border-success opacity-0" style="border-width: 3px;">LIKE</div>
                    <div class="swipe-overlay overlay-nope rotate-12 absolute z-10 top-10 right-6 text-nope border-nope opacity-0" style="border-width: 3px;">NOPE</div>

                    <!-- Poster Section -->
                    <div class="swipe-card-poster">
                        <img src="https://placehold.co/400x400/${movie.id.length % 2 === 0 ? '10b981' : 'ef4444'}/ffffff?text=${movie.title.split(' ').join('+')}" 
                             onerror="this.onerror=null;this.src='https://placehold.co/400x400/10b981/ffffff?text=Poster';" 
                             alt="${movie.title} Poster" 
                             class="w-full h-full object-cover" 
                             loading="lazy"> 
                        
                        <!-- Badges Overlay -->
                        <div class="absolute top-3 left-3 flex space-x-2">
                            <span class="bg-yellow-500 text-secondary text-xs font-bold px-2 py-1 rounded-full shadow-md">IMDb ${movie.imdb}</span>
                            <span class="bg-red-600 text-white text-xs font-bold px-2 py-1 rounded-full shadow-md">RT ${movie.rt}%</span>
                        </div>

                        <!-- Platform Overlay -->
                        <div class="absolute bottom-0 left-0 right-0 p-3 bg-gradient-to-t from-secondary/80 to-transparent">
                            <span class="text-lg font-bold text-white flex items-center">
                                <span class="h-6 w-6 rounded-full ${platformColor} text-white flex items-center justify-center text-xs font-extrabold mr-2">${platformIcon}</span>
                                Available on ${movie.platform}
                            </span>
                        </div>
                    </div>

                    <!-- Details Section -->
                    <div class="swipe-card-details p-4">
                        <div class="flex justify-between items-center mb-2">
                            <h2 class="text-2xl font-bold text-white truncate">${movie.title} (${movie.year})</h2>
                            <span class="text-primary text-xl font-bold">${movie.matchProb}%</span>
                        </div>
                        <p class="text-sm text-gray-400 mb-3">${movie.genre} | ${movie.runtime}</p>
                        
                        <!-- AI Explanation -->
                        <div class="bg-secondary p-3 rounded-lg border border-gray-700 mb-4">
                            <p class="text-xs font-semibold text-primary mb-1">AI Match Insight:</p>
                            <p class="text-sm text-gray-300">${movie.aiSummary}</p>
                        </div>
                        
                        <!-- Movie Moods -->
                        <p class="text-sm text-gray-400 mb-2">Moods: <span class="text-white">${movie.mood}</span></p>

                        <!-- Trailer Button -->
                        <button class="w-full bg-gray-600 text-white py-2 rounded-lg text-sm hover:bg-gray-500 transition duration-150" aria-label="View trailer preview">
                            View Trailer Preview
                        </button>
                    </div>
                </div>
            `;
        }

        function generateSwipeContent() {
            if (!window.isAuthReady) {
                return `
                    <div class="flex flex-col items-center justify-center min-h-[500px] p-8">
                        <svg class="animate-spin h-10 w-10 text-primary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <p class="text-gray-400 mt-4">Waiting for secure connection...</p>
                    </div>
                `;
            }
            
            const movie = MOCK_SWIPE_MOVIES[currentMovieIndex];

            if (!movie) {
                return `
                    <div class="p-8 text-center">
                        <h1 class="text-3xl font-extrabold text-white pt-2 mb-6">Queue Empty!</h1>
                        <p class="text-gray-400">You've reached the end of your current discovery queue.</p>
                        <p class="text-gray-400 mt-2">Try adjusting your filters or checking back later.</p>
                        <button class="mt-6 bg-primary text-white font-bold py-3 px-6 rounded-full hover:bg-orange-500 transition" aria-label="Adjust movie filters">
                            Adjust Filters
                        </button>
                        <p class="mt-8 text-3xl">üçø sad popcorn</p>
                    </div>
                `;
            }

            // The card HTML is generated here
            const cardHtml = getSwipeCardHtml(movie);

            // The rest of the page structure
            const pageHtml = `
                <div class="p-4 flex flex-col items-center justify-start min-h-[calc(100vh-64px-16px)]">
                    <h1 class="text-3xl font-extrabold text-white tracking-tight pt-2 mb-6">Find Your Next Movie</h1>

                    <!-- The Core Swipe Card -->
                    ${cardHtml}
                    
                    <!-- Swipe Action Buttons -->
                    <div class="flex justify-center space-x-6 w-full max-w-sm">
                        
                        <!-- PASS Button (Left) -->
                        <button onclick="handleSwipeAction('pass')" class="action-button bg-gray-600 text-white p-4 rounded-full hover:bg-gray-500 flex-shrink-0" aria-label="Pass on this movie">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-8 h-8">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>

                        <!-- SUPER-LIKE / MUST-WATCH Button (Center) -->
                        <button onclick="handleSwipeAction('superlike')" class="action-button bg-blue-600 text-white p-3 rounded-full hover:bg-blue-500 flex-shrink-0 border-4 border-blue-400" aria-label="Super-like this movie (Must Watch)">
                            <!-- Star Icon for Super-Like -->
                            <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" class="w-10 h-10">
                                <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
                            </svg>
                        </button>
                        
                        <!-- LIKE Button (Right) -->
                        <button onclick="handleSwipeAction('like')" class="action-button bg-primary text-white p-4 rounded-full hover:bg-orange-500 flex-shrink-0" aria-label="Like this movie">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-8 h-8">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.054-4.312 2.655-.715-1.601-2.377-2.655-4.313-2.655C4.099 3.75 2 5.765 2 8.25c0 7.22 9 12 10 12s10-4.78 10-12z" />
                            </svg>
                        </button>
                    </div>

                    <p class="text-sm text-gray-500 mt-4">Drag the card left/right, or use the buttons.</p>
                </div>
            `;
            
            // Set the HTML and immediately setup the listeners for the card
            setTimeout(() => setupSwipeGestureListeners(`movie-card-${movie.id}`), 0); 
            
            return pageHtml;
        }

        // General Notification/Toast System (Mock)
        function showMockNotification(message) {
            const existing = document.getElementById('mock-notification');
            if (existing) existing.remove();

            const notification = document.createElement('div');
            notification.id = 'mock-notification';
            notification.className = 'fixed bottom-20 left-1/2 transform -translate-x-1/2 bg-secondary text-white p-3 rounded-xl shadow-2xl border border-primary z-[100] text-sm opacity-0 transition-opacity duration-300';
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Fade in and out
            setTimeout(() => { notification.style.opacity = 1; }, 50);
            setTimeout(() => { notification.style.opacity = 0; }, 1500);
            setTimeout(() => { notification.remove(); }, 1850);
        }

        // Undo Toast Implementation
        function showUndoToast(movieTitle, action) {
            // Clear any existing timer/toast
            clearTimeout(toastTimeoutId);
            const existing = document.getElementById('undo-toast');
            if (existing) existing.remove();

            const toast = document.createElement('div');
            toast.id = 'undo-toast';
            toast.className = 'fixed bottom-20 left-1/2 transform -translate-x-1/2 w-11/12 max-w-sm bg-gray-800 text-white p-3 rounded-xl shadow-2xl border border-gray-700 z-[100] flex justify-between items-center opacity-0 transition-opacity duration-300';
            
            const message = `${action.toUpperCase()}: ${movieTitle}`;
            
            toast.innerHTML = `
                <span class="text-sm">${message}</span>
                <button onclick="undoLastSwipe()" 
                    class="bg-primary text-white text-xs font-bold py-1 px-3 rounded-lg hover:bg-orange-500 transition duration-150 ml-4"
                    aria-label="Undo last swipe action">
                    UNDO
                </button>
            `;
            
            document.body.appendChild(toast);
            
            // Fade in
            setTimeout(() => { toast.style.opacity = 1; }, 50);

            // Set timeout to auto-remove toast (5 seconds)
            toastTimeoutId = setTimeout(() => {
                toast.style.opacity = 0;
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 5000);
        }


        // UPDATED: renderGroupMatches to include Confetti Trigger
        function renderGroupMatches(selectedGroupName) {
            const matches = MOCK_GROUP_DATA[selectedGroupName] || [];
            // Check for perfect match across the group, and flag to trigger confetti once
            let perfectMatchFound = false;

            const movieMatchCards = matches.map(match => {
                const likedCount = match.likes.length;
                const matchPercentage = Math.round((likedCount / match.totalMembers) * 100);
                const progressColor = matchPercentage === 100 ? 'bg-success' : (matchPercentage >= 75 ? 'bg-primary' : 'bg-yellow-500');

                // Set flag if a 100% match is found in the current group
                if (matchPercentage === 100) {
                    perfectMatchFound = true; 
                }

                return `
                    <div class="bg-card-bg p-4 rounded-xl border border-gray-700 shadow-lg transition hover:shadow-primary/30 hover:ring-2 ring-primary/50">
                        <div class="flex items-start justify-between mb-3">
                            <div>
                                <p class="text-lg font-bold text-white">${match.movie}</p>
                                <p class="text-sm text-gray-400">On: <span class="text-white font-medium">${match.platform}</span></p>
                            </div>
                            <div class="text-3xl font-extrabold ${progressColor}">
                                ${matchPercentage}%
                            </div>
                        </div>

                        <!-- Progress Bar for Group Consensus -->
                        <div class="mb-3">
                            <p class="text-xs text-gray-400 mb-1">Consensus: ${likedCount} / ${match.totalMembers} people liked it</p>
                            <div class="h-2 bg-gray-600 rounded-full overflow-hidden">
                                <div class="h-full ${progressColor} transition-all duration-500" style="width: ${matchPercentage}%"></div>
                            </div>
                        </div>
                        
                        <!-- Liked By Avatars -->
                        <div class="flex items-center mt-2">
                            <span class="text-sm text-gray-400 mr-3">Liked By:</span>
                            <div class="flex -space-x-2">
                                ${match.likes.map(name => `
                                    <div class="h-6 w-6 rounded-full bg-blue-500 border-2 border-card-bg flex items-center justify-center text-xs font-semibold text-white" 
                                         title="${name}">
                                        ${name.charAt(0)}
                                    </div>
                                `).join('')}
                            </div>
                            ${matchPercentage === 100 ? '<span class="ml-3 text-lg perfect-match-icon" title="Perfect Match!">&#127881;</span>' : ''}
                        </div>
                    </div>
                `;
            }).join('');

            // Trigger confetti if a perfect match was detected in this group
            if (perfectMatchFound) {
                // Delay slightly so the UI is fully rendered before explosion
                setTimeout(triggerConfetti, 150); 
            }

            return `
                <h2 class="text-xl font-semibold text-white mb-4 mt-6">Matches for ${selectedGroupName}</h2>
                <div class="space-y-4">
                    ${movieMatchCards.length > 0 
                        ? movieMatchCards 
                        : `<p class="text-center text-gray-500 pt-4">No common matches found. Keep swiping!</p>`}
                </div>
            `;
        }

        function generateMatchesContent() {
            const friends = ["Alex K. & Sarah J.", "The Squad (5 Members)", "Mike T."];
            
            const matchSelectors = friends.map((name, index) => {
                const isActive = index === 0 ? 'active-selection' : '';
                return `
                    <button data-match-name="${name}" class="match-selector flex-shrink-0 bg-primary/20 text-primary border border-primary hover:bg-primary hover:text-white font-medium py-2 px-4 rounded-full transition duration-150 ${isActive}" aria-label="Select match group: ${name}">
                        ${name}
                    </button>
                `;
            }).join('');

            return `
                <div class="p-4">
                    <h1 class="text-3xl font-extrabold text-white tracking-tight pt-2 mb-6">Group & Couple Matches</h1>
                    
                    <h2 class="text-lg font-medium text-white mb-3">Select Watch Group</h2>
                    <div id="match-selector-bar" class="flex overflow-x-auto pb-4 mb-6 space-x-3">
                        ${matchSelectors}
                    </div>

                    <div id="group-match-results">
                        ${renderGroupMatches("Alex K. & Sarah J.")} 
                    </div>
                    
                    <h2 class="text-xl font-semibold text-white mb-4 mt-8 border-t border-gray-700 pt-6">Discovery Tools</h2>
                    <div class="space-y-4">
                        <div class="bg-card-bg p-4 rounded-xl shadow-md border border-gray-700 cursor-pointer hover:bg-gray-600 transition" aria-label="Open AI Movie Assistant">
                            <h3 class="font-bold text-white text-lg">AI Movie Assistant</h3>
                            <p class="text-sm text-gray-400">Ask for film suggestions based on mood, platform, and who you're watching with.</p>
                        </div>
                        <div class="bg-card-bg p-4 rounded-xl shadow-md border border-gray-700 cursor-pointer hover:bg-gray-600 transition" aria-label="Open Mystery Movie Wheel">
                            <h3 class="font-bold text-white text-lg">Mystery Movie Wheel</h3>
                            <p class="text-sm text-gray-400">Spin the wheel for a surprise suggestion (Challenge Mode).</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function setupMatchSelectorListener() {
            const selectorBar = document.getElementById('match-selector-bar');
            const matchResultsArea = document.getElementById('group-match-results');

            if (selectorBar && matchResultsArea) {
                selectorBar.addEventListener('click', (e) => {
                    const selector = e.target.closest('.match-selector');
                    if (selector) {
                        const selectedName = selector.getAttribute('data-match-name');
                        document.querySelectorAll('.match-selector').forEach(btn => {
                            btn.classList.remove('active-selection');
                        });
                        selector.classList.add('active-selection');
                        matchResultsArea.innerHTML = renderGroupMatches(selectedName);
                    }
                });
            }
        }


        function generateProfileContent() {
             const platformList = MOCK_PLATFORMS.map(p => `
                <div class="flex justify-between items-center py-3 border-b border-gray-700 last:border-b-0">
                    <div class="flex items-center space-x-3">
                        <div class="h-8 w-8 rounded-full bg-card-bg border-2 border-gray-600 flex items-center justify-center text-lg font-bold ${p.color}">${p.icon}</div>
                        <span class="text-gray-200">${p.name}</span>
                    </div>
                    <button class="text-sm font-medium px-3 py-1 rounded-full 
                        ${p.status === 'Connected' 
                            ? 'bg-red-600 text-white hover:bg-red-700' 
                            : 'bg-primary text-white hover:bg-orange-500'}" aria-label="${p.status === 'Connected' ? 'Disconnect' : 'Connect'} ${p.name}">
                        ${p.status === 'Connected' ? 'Disconnect' : 'Connect'}
                    </button>
                </div>
            `).join('');

            const warningSettings = MOCK_WARNING_SETTINGS.map(w => `
                <div class="flex justify-between items-center py-3 border-b border-gray-700 last:border-b-0">
                    <span class="text-gray-200">${w.label}</span>
                    <label class="toggle-switch" aria-label="Toggle ${w.label} warning">
                        <input type="checkbox" ${w.enabled ? 'checked' : ''} onchange="console.log('Toggle for ${w.label} changed')">
                        <span class="slider"></span>
                    </label>
                </div>
            `).join('');


            return `
                <div class="p-4">
                    <h1 class="text-3xl font-extrabold text-white tracking-tight pt-2 mb-6">My Profile</h1>
                    
                    <div class="bg-card-bg rounded-xl p-6 text-center shadow-xl mb-8">
                        <img src="https://placehold.co/100x100/f97316/ffffff?text=U" onerror="this.onerror=null;this.src='https://placehold.co/100x100/f97316/ffffff?text=User';" alt="Profile Avatar" class="w-24 h-24 rounded-full mx-auto border-4 border-primary mb-4">
                        <h2 class="text-2xl font-bold text-white">Movie Enthusiast</h2>
                        <p class="text-sm text-gray-400">XP Level 14 | Horror Duo Badge</p>
                    </div>

                    <div class="bg-secondary rounded-xl p-4 shadow-xl mb-8 border border-gray-700">
                        <h2 class="text-xl font-semibold text-white mb-4">Authentication Details</h2>
                        <p class="text-sm text-gray-400 mb-2">Your unique ID for grouping with friends:</p>
                        <code class="block bg-gray-800 text-green-400 p-2 rounded-lg text-xs break-all">${window.userId || 'Loading...'}</code>
                        <p class="text-xs text-gray-500 mt-2">Status: ${window.db ? 'Connected to Firebase' : 'Initializing'}</p>
                    </div>

                    <h2 class="text-xl font-semibold text-white mb-4 mt-6">Associated Platforms</h2>
                    <p class="text-sm text-gray-400 mb-4">Connect streaming services to see shared matches and availability.</p>
                    <div class="bg-secondary rounded-xl p-4 shadow-xl mb-8 border border-gray-700">
                        ${platformList}
                    </div>

                    <h2 class="text-xl font-semibold text-white mb-4">Trigger Warning Settings</h2>
                    <p class="text-sm text-gray-400 mb-4">Toggle sensitive topics you wish to filter or receive warnings for in recommendations.</p>
                    <div class="bg-secondary rounded-xl p-4 shadow-xl mb-8 border border-gray-700">
                        ${warningSettings}
                    </div>
                    
                    <h2 class="text-xl font-semibold text-white mb-4">Viewing Preferences</h2>
                    <div class="space-y-4 mb-8">
                        <div class="bg-card-bg rounded-lg p-4 flex justify-between items-center">
                            <span class="text-gray-300">Favorite Genre:</span>
                            <span class="text-primary font-medium">Sci-Fi & Action</span>
                        </div>
                        <div class="bg-card-bg rounded-lg p-4 flex justify-between items-center">
                            <span class="text-gray-300">Max Runtime (mins):</span>
                            <span class="text-primary font-medium">150</span>
                        </div>
                    </div>

                    <button class="w-full bg-red-600 text-white font-bold py-3 rounded-lg hover:bg-red-700 transition shadow-lg" aria-label="Log out of the application">
                        Log Out
                    </button>
                </div>
            `;
        }
        
        // Add event listeners for navigation
        const navItems = document.querySelectorAll('.nav-item');
        navItems.forEach(item => {
            item.addEventListener('click', () => {
                const tabName = item.getAttribute('data-tab');
                setActiveTab(tabName);
            });
        });

        // Function to control tab switching and content rendering
        function setActiveTab(tabName) {
            const contentArea = document.getElementById('content-area');
            const navItems = document.querySelectorAll('.nav-item');
            
            navItems.forEach(item => {
                if (item.getAttribute('data-tab') === tabName) {
                    item.classList.add('active');
                    item.classList.add('text-primary');
                    item.classList.remove('text-gray-400');
                } else {
                    item.classList.remove('active');
                    item.classList.remove('text-primary');
                    item.classList.add('text-gray-400');
                }
            });

            // Render content based on tab
            switch (tabName) {
                case 'watchlist':
                    contentArea.innerHTML = generateWatchlistContent();
                    break;
                case 'swipe':
                    contentArea.innerHTML = generateSwipeContent();
                    break;
                case 'matches':
                    contentArea.innerHTML = generateMatchesContent();
                    setupMatchSelectorListener();
                    break;
                case 'profile':
                    contentArea.innerHTML = generateProfileContent();
                    break;
                default:
                    contentArea.innerHTML = `<div class="p-4 text-center text-gray-500">Page not found.</div>`;
            }
        }
        
        // Final Initialization Function - Called ONLY when Firebase is ready
        window.initializeAppContent = () => {
             preloadNextMovie();
             setActiveTab('swipe');
        };


        // Initialization: Preload the first next card and start the app
        window.onload = () => {
             // Start Firebase initialization and auth handshake
             window.setupFirebase();
             
             // Initial render is the loading state defined in the HTML structure
        };
    </script>
</body>
</html>
