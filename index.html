<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie Picker - 5 Tab</title>
    
    <!-- PWA Manifest & Theme -->
    <meta name="theme-color" content="#f97316">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.js"></script>
    
    <!-- FIREBASE MODULE IMPORTS -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"; // Optional: Use for debugging

        // Access global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-movie-picker-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        let userId = null;
        let isAuthReady = false;

        // Function to initialize Firebase and authenticate
        async function setupFirebase() {
            try {
                // setLogLevel('debug'); // Uncomment to see Firebase logs
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // 1. Listen for auth state changes
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        window.userId = user.uid;
                    } else {
                        window.userId = 'guest-' + crypto.randomUUID().substring(0, 8);
                    }
                    
                    if (!window.isAuthReady) {
                        window.isAuthReady = true;
                        window.initializeAppContent();
                    }
                    window.db = db;
                });

                // 2. Perform initial sign-in
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase Initialization or Auth Failed:", error);
                window.userId = 'guest-fail-' + crypto.randomUUID().substring(0, 8);
                window.isAuthReady = true;
                window.initializeAppContent();
            }
        }
        
        // Expose Firebase components to the main script block
        window.setupFirebase = setupFirebase;
        window.db = db; 
        window.userId = userId;
        window.isAuthReady = isAuthReady;
        window.setDoc = setDoc;
        window.doc = doc;
        window.serverTimestamp = serverTimestamp;
        window.appId = appId;
    </script>
    
    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#f97316', // Orange
                        'secondary': '#1f2937', // Dark Grey
                        'card-bg': '#374151', // Medium Grey
                        'love': '#3b82f6', // Blue for "Love that!"
                        'like': '#10b981', // Green for "Like"
                        'maybe': '#f59e0b', // Yellow for "Maybe"
                        'nope': '#ef4444', // Red for "No, thank you!"
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                }
            }
        }
    </script>
    <style>
        /* General Styles */
        :root {
            --app-bg: #111827;
            --main-text: #f3f4f6;
            --primary-color: #f97316;
        }
        .dark-mode {
            --app-bg: #111827;
            --main-text: #f3f4f6;
        }
        .light-mode {
            --app-bg: #f3f4f6;
            --main-text: #111827;
            background-color: var(--app-bg);
            color: var(--main-text);
        }
        body { background-color: var(--app-bg); color: var(--main-text); font-family: 'Inter', sans-serif; transition: background-color 0.3s; }
        .app-container { max-width: 420px; margin: 0 auto; min-height: 100dvh; display: flex; flex-direction: column; box-shadow: 0 0 25px rgba(0,0,0,0.5); background-color: #1f2937; transition: background-color 0.3s; }
        
        /* Layout */
        .tab-content { flex-grow: 1; overflow-y: auto; padding-bottom: 72px; }
        .nav-bar { position: fixed; bottom: 0; left: 0; right: 0; max-width: 420px; margin: 0 auto; background-color: #111827; border-top: 1px solid #374151; height: 64px; z-index: 20; }
        .nav-item.active { color: var(--primary-color); }
        
        /* Swipe Card */
        .swipe-card { width: 100%; max-width: 380px; height: 550px; margin: 0 auto; position: relative; overflow: hidden; background-color: #374151; transition: transform 0.3s ease-out, opacity 0.3s ease-out; cursor: grab; touch-action: none; will-change: transform; }
        .swipe-overlay { position: absolute; top: 20px; z-index: 10; padding: 8px 16px; border-radius: 8px; font-size: 32px; font-weight: 800; text-transform: uppercase; letter-spacing: 2px; opacity: 0; transform: scale(0.8) rotate(0deg); transition: opacity 0.1s, transform 0.1s; }
        .overlay-love { border: 5px solid #3b82f6; color: #3b82f6; left: 20px; transform: rotate(-25deg); }
        .overlay-like { border: 5px solid #10b981; color: #10b981; left: 20px; transform: rotate(-25deg); }
        .overlay-maybe { border: 5px solid #f59e0b; color: #f59e0b; right: 20px; transform: rotate(25deg); }
        .overlay-nope { border: 5px solid #ef4444; color: #ef4444; right: 20px; transform: rotate(25deg); }
        .action-button { transition: all 0.1s ease-in-out; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .action-button:active { transform: scale(0.95); }
        #undo-toast { bottom: 80px; transition: transform 0.3s ease-out; }
        
        /* Modal Backdrop */
        .modal-backdrop { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.8); z-index: 50; display: none; align-items: center; justify-center; overflow-y: auto; }

    </style>
</head>
<body class="dark-mode">
    <div class="app-container">
        
        <!-- Main Content Area -->
        <div id="content-area" class="tab-content">
            <!-- Loading state before Firebase is ready -->
            <div id="loading-spinner" class="flex flex-col items-center justify-center min-h-[500px] p-8">
                <svg class="animate-spin h-10 w-10 text-primary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="text-gray-400 mt-4">Initializing application...</p>
            </div>
        </div>

        <!-- Fixed Bottom Navigation Bar -->
        <div id="nav-bar" class="nav-bar flex justify-around items-center">
            
            <!-- Home Tab -->
            <button class="nav-item flex flex-col items-center p-2 text-gray-400 hover:text-primary transition" data-tab="home" aria-label="Go to Home dashboard">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.149-.439 1.588 0L21.75 12M4.5 9.75v10.125a3 3 0 003 3h8.25a3 3 0 003-3V9.75M12 18.75a3.75 3.75 0 100-7.5 3.75 3.75 0 000 7.5z" />
                </svg>
                <span class="text-xs">Home</span>
            </button>

            <!-- Library Tab -->
            <button class="nav-item flex flex-col items-center p-2 text-gray-400 hover:text-primary transition" data-tab="library" aria-label="Go to Movie Library">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 7.5h1.5m-1.5 3h1.5m-7.5 3h7.5m-7.5 3h7.5M12 21a9 9 0 100-18 9 9 0 000 18z" />
                </svg>
                <span class="text-xs">Library</span>
            </button>
            
            <!-- Swipe Tab (Default Active) -->
            <button class="nav-item flex flex-col items-center p-2 text-primary active transition" data-tab="swipe" aria-label="Start swiping for new movies">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M7.5 7.5l7.5 7.5m0-7.5l-7.5 7.5M10.5 6a7.5 7.5 0 100 15 7.5 7.5 0 000-15z" />
                </svg>
                <span class="text-xs">Swipe</span>
            </button>

            <!-- Matches Tab -->
            <button class="nav-item flex flex-col items-center p-2 text-gray-400 hover:text-primary transition" data-tab="matches" aria-label="View group and couple matches">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.054-4.312 2.655-.715-1.601-2.377-2.655-4.313-2.655C4.099 3.75 2 5.765 2 8.25c0 7.22 9 12 10 12s10-4.78 10-12z" />
                </svg>
                <span class="text-xs">Matches</span>
            </button>

            <!-- Profile/Settings Tab -->
            <button class="nav-item flex flex-col items-center p-2 text-gray-400 hover:text-primary transition" data-tab="profile" aria-label="View profile and settings">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 19.5a2.25 2.25 0 01-1.8-2.25v-.75a1.5 1.5 0 011.5-1.5h16.5a1.5 1.5 0 011.5 1.5v.75a2.25 2.25 0 01-1.8 2.25H4.501z" />
                </svg>
                <span class="text-xs">Profile</span>
            </button>
        </div>
        
        <!-- Modal Container for Movie Details -->
        <div id="movie-detail-modal" class="modal-backdrop">
            <div class="bg-secondary rounded-xl w-11/12 max-w-md p-6 shadow-2xl relative max-h-[90vh] overflow-y-auto">
                <button onclick="closeModal()" class="absolute top-3 right-3 text-gray-400 hover:text-white transition" aria-label="Close movie details">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
                <div id="modal-content">
                    <!-- Dynamic content will be loaded here -->
                </div>
            </div>
        </div>
    </div>
    <script>
        // --- Core Scoring Logic ---
        const SWIPE_SCORES = {
            'love': 4,
            'like': 3,
            'maybe': 1,
            'pass': 0
        };

        // --- Mock Data ---
        const MOCK_PLATFORMS = [
            { name: "Netflix", status: "Connected", icon: "N", color: "text-red-600" },
            { name: "Hulu", status: "Connected", icon: "H", color: "text-green-500" },
            { name: "Max (HBO)", status: "Disconnected", icon: "M", color: "text-blue-500" },
        ];
        
        // Detailed Movie Data for Library and Swipe
        const MOCK_SWIPE_MOVIES = [
            {
                id: "void-walker-2024",
                title: "The Void Walker",
                year: 2024,
                genre: "Sci-Fi / Mystery",
                type: "Movie",
                runtime: "128 min",
                imdb: 8.4,
                rt: 94,
                platform: "Netflix",
                actors: ["Anya Taylor-Joy", "Cillian Murphy"],
                trigger: ["Flashing Lights", "Isolation"],
                synopsis: "A lone astronaut wakes up millions of miles from Earth with no memory of his mission, but a growing sense of dread about what he left behind.",
                mood: "Mind-blowing, Thrilling",
            },
            {
                id: "echoes-2023",
                title: "Echoes of Tomorrow",
                year: 2023,
                genre: "Drama / Romance",
                type: "Series (Limited)",
                runtime: "6 Episodes",
                imdb: 7.9,
                rt: 88,
                platform: "Prime Video",
                actors: ["Tom Hanks", "Zendaya"],
                trigger: ["Emotional Loss", "Smoking"],
                synopsis: "A poignant limited series exploring two people's lives across parallel dimensions, searching for a moment they missed in time.",
                mood: "Cozy, Feel-good",
            },
            {
                id: "crystal-king-2022",
                title: "Crystal King",
                year: 2022,
                genre: "Fantasy / Adventure",
                type: "Movie",
                runtime: "145 min",
                imdb: 8.1,
                rt: 90,
                platform: "Hulu",
                actors: ["Chris Hemsworth", "Cate Blanchett"],
                trigger: ["High Violence", "Large Spiders"],
                synopsis: "The legend of the Crystal King resurfaces when a young peasant discovers a shard of the magical crystal, leading him on an epic quest.",
                mood: "Epic, Visual Spectacle",
            },
            {
                id: "rogue-protocol-2021",
                title: "Rogue Protocol",
                year: 2021,
                genre: "Action / Thriller",
                type: "Movie",
                runtime: "98 min",
                imdb: 7.5,
                rt: 82,
                platform: "Max (HBO)",
                actors: ["Idris Elba", "Gal Gadot"],
                trigger: ["Needles / Injections"],
                synopsis: "A rogue agent must race against time to expose a global conspiracy before a biological weapon is unleashed on a major city.",
                mood: "Fast-paced, Intense",
            }
        ].sort(() => Math.random() - 0.5); // Shuffle for swipe sequence

        // Updated Match Data with detailed swipe actions
        const MOCK_GROUP_DATA_RANKED = {
            "Alex K. (Couple)": [
                // Total possible score: 2 * 4 = 8. Actual: 4 + 4 = 8. Match: 100%
                { movie: "Perfect Match Movie", swipes: [{user: "You", action: "love"}, {user: "Alex K.", action: "love"}], totalMembers: 2, platform: "Hulu", status: "Partner's status: Available" }, 
                // Total possible score: 8. Actual: 4 + 3 = 7. Match: 87.5%
                { movie: "High Score Hit", swipes: [{user: "You", action: "love"}, {user: "Alex K.", action: "like"}], totalMembers: 2, platform: "Netflix", status: "Partner's status: Busy until 8 PM" },
                // Total possible score: 8. Actual: 3 + 1 = 4. Match: 50%
                { movie: "Middle Ground Film", swipes: [{user: "You", action: "like"}, {user: "Alex K.", action: "maybe"}], totalMembers: 2, platform: "Prime Video", status: "Partner's status: Not specified" },
            ],
            "Sarah J. (Friend)": [
                // Total possible score: 8. Actual: 4 + 0 = 4. Match: 50%
                { movie: "Controversial Hit", swipes: [{user: "You", action: "love"}, {user: "Sarah J.", action: "pass"}], totalMembers: 2, platform: "Max (HBO)" },
                // Total possible score: 8. Actual: 3 + 3 = 6. Match: 75%
                { movie: "Solid Choice", swipes: [{user: "You", action: "like"}, {user: "Sarah J.", action: "like"}], totalMembers: 2, platform: "Hulu" },
            ],
            "The Squad (5 Members)": [
                // Total possible score: 5 * 4 = 20. Actual: 4*4 + 0 = 16. Match: 80%
                { movie: "Group Favorite", swipes: [{user: "You", action: "love"}, {user: "Tom", action: "love"}, {user: "Jess", action: "love"}, {user: "Mike", action: "love"}, {user: "Alex", action: "pass"}], totalMembers: 5, platform: "Max (HBO)" },
                // Total possible score: 20. Actual: 5 * 3 = 15. Match: 75%
                { movie: "Action Protocol 7", swipes: [{user: "You", action: "like"}, {user: "Tom", action: "like"}, {user: "Jess", action: "like"}, {user: "Mike", action: "like"}, {user: "Alex", action: "like"}], totalMembers: 5, platform: "Hulu" },
            ]
        };


        let swipeHistory = [];
        let currentMovieIndex = 0;
        let toastTimeoutId = null; 
        let isDarkMode = true; // Global state for dark/light mode

        // --- Utility Functions ---

        const triggerConfetti = () => {
            confetti({
                particleCount: 200,
                spread: 120,
                gravity: 0.8,
                decay: 0.95,
                scalar: 1.2,
                zIndex: 1000,
                origin: { y: 0.6 }
            });
        };

        // --- Theme Toggling ---
        window.toggleTheme = function() {
            isDarkMode = !isDarkMode;
            const body = document.body;
            body.classList.toggle('dark-mode', isDarkMode);
            body.classList.toggle('light-mode', !isDarkMode);
            
            // Update the toggle switch visually if necessary
            const toggle = document.getElementById('dark-mode-toggle');
            if (toggle) toggle.checked = isDarkMode;
            
            showMockNotification(`Switched to ${isDarkMode ? 'Dark' : 'Light'} Mode.`);
        }

        // --- Modal Control ---
        window.showMovieDetailsModal = function(movieId) {
            const movie = MOCK_SWIPE_MOVIES.find(m => m.id === movieId);
            if (!movie) return;

            const modal = document.getElementById('movie-detail-modal');
            const modalContent = document.getElementById('modal-content');
            
            // Get platform icon/color helper
            const { platformIcon, platformColor } = getPlatformStyle(movie.platform);

            modalContent.innerHTML = `
                <div class="pt-2 pb-1">
                    <img src="https://placehold.co/400x200/3b82f6/ffffff?text=${movie.title.split(' ').join('+')}" 
                         alt="${movie.title} Poster" class="w-full h-48 object-cover rounded-lg mb-4">
                    
                    <h2 class="text-3xl font-bold text-white mb-2">${movie.title} (${movie.year})</h2>
                    <div class="flex flex-wrap gap-2 text-sm text-gray-400 mb-4 border-b border-gray-700 pb-3">
                        <span class="px-2 py-1 rounded-full bg-primary/20 text-primary">${movie.type}</span>
                        <span class="px-2 py-1 rounded-full bg-gray-600">${movie.genre}</span>
                        <span class="px-2 py-1 rounded-full bg-gray-600">${movie.runtime}</span>
                        <span class="px-2 py-1 rounded-full bg-yellow-500 text-secondary font-bold">IMDb ${movie.imdb}</span>
                    </div>

                    <!-- Synopsis -->
                    <p class="text-gray-300 mb-5">${movie.synopsis}</p>
                    
                    <!-- Details Grid -->
                    <div class="grid grid-cols-2 gap-4 text-sm mb-5">
                        <div>
                            <p class="font-semibold text-gray-400">Available On:</p>
                            <span class="font-medium text-white flex items-center mt-1">
                                <span class="h-5 w-5 rounded-full ${platformColor} text-white flex items-center justify-center text-xs font-extrabold mr-2">${platformIcon}</span>
                                ${movie.platform}
                            </span>
                        </div>
                        <div>
                            <p class="font-semibold text-gray-400">Mood:</p>
                            <p class="font-medium text-white mt-1">${movie.mood}</p>
                        </div>
                        <div>
                            <p class="font-semibold text-gray-400">Main Actors:</p>
                            <p class="font-medium text-white mt-1">${movie.actors.join(', ')}</p>
                        </div>
                    </div>
                    
                    <!-- Trigger Warnings -->
                    <div class="bg-red-900/30 p-3 rounded-lg border border-red-700 mb-5">
                        <p class="font-semibold text-red-400 mb-2 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.865 1.446-.865 3.376 0 4.821 1.065 1.761 2.984 2.378 4.78 2.378H18.23c1.796 0 3.714-.617 4.779-2.378.865-1.447.865-3.376 0-4.821-1.065-1.761-2.984-2.378-4.779-2.378H4.257z" />
                            </svg>
                            Trigger Warnings:
                        </p>
                        <ul class="list-disc list-inside text-sm text-red-300">
                            ${movie.trigger.map(t => `<li>${t}</li>`).join('')}
                        </ul>
                    </div>
                    
                    <!-- Trailer Link (Mock) -->
                    <button class="w-full bg-primary text-white font-bold py-3 rounded-lg hover:bg-orange-500 transition shadow-lg mt-3" aria-label="Watch Trailer for ${movie.title}">
                        Watch Trailer (External Link)
                    </button>
                </div>
            `;

            modal.style.display = 'flex';
        }

        window.closeModal = function() {
            document.getElementById('movie-detail-modal').style.display = 'none';
        }

        // --- Swipe Logic ---
        let isDragging = false;
        let startX = 0;
        const SWIPE_THRESHOLD = 100;

        function getPlatformStyle(platform) {
            let platformIcon, platformColor;
            switch(platform) {
                case 'Netflix': platformIcon = 'N'; platformColor = 'bg-red-600'; break;
                case 'Prime Video': platformIcon = 'P'; platformColor = 'bg-sky-400'; break;
                case 'Hulu': platformIcon = 'H'; platformColor = 'bg-green-500'; break;
                case 'Max (HBO)': platformIcon = 'M'; platformColor = 'bg-blue-500'; break;
                default: platformIcon = '?'; platformColor = 'bg-gray-500';
            }
            return { platformIcon, platformColor };
        }

        async function handleSwipeAction(action, cardToSwipe = null) {
            if (!window.isAuthReady) {
                showMockNotification("App is still initializing. Please wait.");
                return;
            }
            
            const movie = MOCK_SWIPE_MOVIES[currentMovieIndex];
            const card = cardToSwipe || document.querySelector('.swipe-card');
            
            if (!movie || !card) return;

            // 1. Save swipe action to Firestore
            try {
                const swipeData = {
                    action: action, // 'love', 'like', 'maybe', or 'pass'
                    score: SWIPE_SCORES[action], // Save the score for easy match calculations
                    timestamp: window.serverTimestamp(),
                    movieTitle: movie.title,
                    movieId: movie.id,
                };
                
                // Firestore path: /artifacts/{appId}/users/{userId}/swipes/{movieId}
                const swipeRef = window.doc(window.db, 
                    'artifacts', window.appId, 
                    'users', window.userId, 
                    'swipes', movie.id
                );

                await window.setDoc(swipeRef, swipeData);
                console.log(`Swipe saved: ${action} for ${movie.title} with score ${swipeData.score}`);
                
            } catch (e) {
                console.error("Error saving swipe to Firestore: ", e);
                showMockNotification("Error saving swipe! Check console.");
            }
            
            // 2. Store action for potential undo
            swipeHistory.push({ index: currentMovieIndex, movie, action });

            // 3. Haptic Feedback
            if (navigator.vibrate) {
                navigator.vibrate(action === 'love' ? [50, 50, 50] : [30]);
            }
            
            // 4. Determine exit transform
            let exitTransform;
            if (action === 'pass' || action === 'maybe') {
                exitTransform = 'translateX(-200vw) rotate(-25deg)'; 
            } else { // 'like' or 'love'
                exitTransform = 'translateX(200vw) rotate(25deg)';
            }
            
            // 5. Apply exit animation
            card.style.transition = 'transform 0.4s ease-in-out, opacity 0.4s ease-in-out';
            card.style.transform = exitTransform;
            card.style.opacity = 0;

            // 6. Load next card and show toast after animation completes
            setTimeout(() => {
                currentMovieIndex++;
                setActiveTab('swipe'); 
                showUndoToast(movie.title, action);
            }, 400);
        }

        window.undoLastSwipe = function() {
            if (swipeHistory.length === 0) return;
            
            const lastSwipe = swipeHistory.pop();
            if (!lastSwipe) return;

            currentMovieIndex = lastSwipe.index;
            
            showMockNotification(`Undo successful! ${lastSwipe.movie.title} is back.`);
            setActiveTab('swipe'); 

            clearTimeout(toastTimeoutId);
            const toast = document.getElementById('undo-toast');
            if (toast) toast.remove();
        }

        function setupSwipeGestureListeners(cardId) {
            const card = document.getElementById(cardId);
            if (!card) return;

            const events = {
                start: (e) => {
                    isDragging = true;
                    startX = e.clientX || e.touches[0].clientX;
                    card.style.transition = 'none';
                },
                move: (e) => {
                    if (!isDragging) return;
                    const currentX = e.clientX || e.touches[0].clientX;
                    const deltaX = currentX - startX;
                    const rotation = (deltaX / 300) * 15; 
                    card.style.transform = `translateX(${deltaX}px) rotate(${rotation}deg)`;

                    // Handle Visual Overlays
                    const overlays = { 
                        like: card.querySelector('.overlay-like'),
                        love: card.querySelector('.overlay-love'),
                        maybe: card.querySelector('.overlay-maybe'),
                        nope: card.querySelector('.overlay-nope')
                    };
                    Object.values(overlays).forEach(o => o.style.opacity = 0); // Hide all first

                    const opacity = Math.min(Math.abs(deltaX) / SWIPE_THRESHOLD * 2, 1);

                    if (deltaX > 20) { // Dragging right (LIKE/LOVE)
                        if (deltaX > 150) { // Far right for LOVE
                            overlays.love.style.opacity = opacity;
                            overlays.love.style.transform = `rotate(-25deg) scale(${0.8 + 0.2 * opacity})`;
                        } else { // Close right for LIKE
                            overlays.like.style.opacity = opacity;
                            overlays.like.style.transform = `rotate(-25deg) scale(${0.8 + 0.2 * opacity})`;
                        }
                    } else if (deltaX < -20) { // Dragging left (NOPE/MAYBE)
                         if (deltaX < -150) { // Far left for NOPE
                            overlays.nope.style.opacity = opacity;
                            overlays.nope.style.transform = `rotate(25deg) scale(${0.8 + 0.2 * opacity})`;
                        } else { // Close left for MAYBE
                            overlays.maybe.style.opacity = opacity;
                            overlays.maybe.style.transform = `rotate(25deg) scale(${0.8 + 0.2 * opacity})`;
                        }
                    }
                },
                end: (e) => {
                    if (!isDragging) return;
                    isDragging = false;
                    card.querySelectorAll('.swipe-overlay').forEach(overlay => {
                        overlay.style.opacity = 0;
                        overlay.style.transform = 'scale(0.8) rotate(0deg)';
                    });
                    card.style.transition = 'transform 0.3s ease-out, opacity 0.3s ease-out';
                    
                    const eventData = e.changedTouches ? e.changedTouches[0] : e;
                    const deltaX = (eventData.clientX || eventData.screenX) - startX;

                    if (deltaX > 150) {
                        handleSwipeAction('love', card);
                    } else if (deltaX > SWIPE_THRESHOLD) {
                        handleSwipeAction('like', card);
                    } else if (deltaX < -150) {
                        handleSwipeAction('pass', card); // 'No, thank you !' is 'pass'
                    } else if (deltaX < -SWIPE_THRESHOLD) {
                         handleSwipeAction('maybe', card);
                    } else {
                        card.style.transform = 'translateX(0) rotate(0)';
                    }
                }
            };

            // Setup listeners
            card.addEventListener('mousedown', events.start);
            document.addEventListener('mousemove', events.move);
            document.addEventListener('mouseup', events.end);
            document.addEventListener('mouseleave', (e) => { if(isDragging) events.end(e); });

            card.addEventListener('touchstart', (e) => { events.start(e.touches[0]); }, { passive: true }); 
            card.addEventListener('touchmove', (e) => { e.preventDefault(); events.move(e.touches[0]); }, { passive: false }); 
            card.addEventListener('touchend', events.end);
            card.addEventListener('touchcancel', events.end);
        }

        function setupSwipeButtonListeners() {
            document.querySelectorAll('.swipe-action-button').forEach(button => {
                button.addEventListener('click', () => {
                    handleSwipeAction(button.getAttribute('data-action'));
                });
            });
        }

        // --- Content Generation Functions ---

        function generateHomeContent() {
            const connectedPlatforms = MOCK_PLATFORMS.filter(p => p.status === 'Connected');
            
            return `
                <div class="p-4">
                    <h1 class="text-3xl font-extrabold text-white tracking-tight pt-2 mb-6">Welcome Back!</h1>
                    
                    <!-- Recommendations from Associated Platforms -->
                    <h2 class="text-xl font-semibold text-white mb-4">Streamline Recommendations</h2>
                    <div class="bg-secondary rounded-xl p-4 mb-8 shadow-lg border border-gray-700">
                        <p class="text-sm text-gray-400 mb-3">Based on your connected platforms: ${connectedPlatforms.map(p => p.name).join(', ')}</p>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center text-sm bg-card-bg p-3 rounded-lg">
                                <span class="text-white">The Nebula (Netflix exclusive)</span>
                                <span class="text-primary font-medium">95% Match</span>
                            </div>
                            <div class="flex justify-between items-center text-sm bg-card-bg p-3 rounded-lg">
                                <span class="text-white">The Long Night (Hulu)</span>
                                <span class="text-primary font-medium">88% Match</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Recommendations Based on Watched History -->
                    <h2 class="text-xl font-semibold text-white mb-4">Inspired by Your History</h2>
                    <div class="flex overflow-x-auto space-x-4 pb-4 mb-8">
                        ${MOCK_SWIPE_MOVIES.slice(1, 3).map(movie => `
                            <div class="flex-shrink-0 w-32 cursor-pointer" onclick="showMovieDetailsModal('${movie.id}')">
                                <img src="https://placehold.co/128x192/ef4444/ffffff?text=${movie.title.split(' ').slice(0, 2).join('+')}" class="w-full h-48 object-cover rounded-lg shadow-md" onerror="this.onerror=null;this.src='https://placehold.co/128x192/ef4444/ffffff?text=Poster';">
                                <p class="text-sm text-white mt-2 truncate">${movie.title}</p>
                                <p class="text-xs text-gray-400">${movie.year}</p>
                            </div>
                        `).join('')}
                    </div>

                    <!-- Trending Movies/Series -->
                    <h2 class="text-xl font-semibold text-white mb-4">Trending Globally</h2>
                    <div class="space-y-4">
                        <div class="bg-card-bg p-4 rounded-xl flex items-center shadow-md">
                            <span class="text-3xl font-extrabold text-primary mr-4">#1</span>
                            <div>
                                <p class="text-white font-semibold">The Quantum Rift (Movie)</p>
                                <p class="text-sm text-gray-400">Action, Sci-Fi | +10k new swipes today</p>
                            </div>
                        </div>
                        <div class="bg-card-bg p-4 rounded-xl flex items-center shadow-md">
                            <span class="text-3xl font-extrabold text-primary mr-4">#2</span>
                            <div>
                                <p class="text-white font-semibold">Castle of Cards (Series)</p>
                                <p class="text-sm text-gray-400">Political Drama | Trending on Netflix</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function getSwipeCardHtml(movie) {
            const { platformIcon, platformColor } = getPlatformStyle(movie.platform);

            return `
                <div id="movie-card-${movie.id}" class="swipe-card rounded-2xl shadow-2xl mb-8">
                    
                    <!-- Overlay Stamps (LOVE/LIKE/MAYBE/NOPE) -->
                    <div class="swipe-overlay overlay-love -rotate-12 absolute z-10 top-10 left-6 text-love border-love opacity-0">LOVE</div>
                    <div class="swipe-overlay overlay-like -rotate-12 absolute z-10 top-10 left-6 text-like border-like opacity-0">LIKE</div>
                    <div class="swipe-overlay overlay-maybe rotate-12 absolute z-10 top-10 right-6 text-maybe border-maybe opacity-0">MAYBE</div>
                    <div class="swipe-overlay overlay-nope rotate-12 absolute z-10 top-10 right-6 text-nope border-nope opacity-0">NOPE</div>

                    <!-- Poster Section -->
                    <div class="swipe-card-poster h-60 relative">
                        <img src="https://placehold.co/400x300/3b82f6/ffffff?text=${movie.title.split(' ').join('+')}" 
                             onerror="this.onerror=null;this.src='https://placehold.co/400x300/3b82f6/ffffff?text=Poster';" 
                             alt="${movie.title} Poster" 
                             class="w-full h-full object-cover" 
                             loading="lazy"> 
                        
                        <!-- Badges Overlay -->
                        <div class="absolute top-3 left-3 flex space-x-2">
                            <span class="bg-yellow-500 text-secondary text-xs font-bold px-2 py-1 rounded-full shadow-md">IMDb ${movie.imdb}</span>
                            <span class="bg-red-600 text-white text-xs font-bold px-2 py-1 rounded-full shadow-md">RT ${movie.rt}%</span>
                        </div>

                        <!-- Platform Overlay -->
                        <div class="absolute bottom-0 left-0 right-0 p-3 bg-gradient-to-t from-secondary/80 to-transparent">
                            <span class="text-lg font-bold text-white flex items-center">
                                <span class="h-6 w-6 rounded-full ${platformColor} text-white flex items-center justify-center text-xs font-extrabold mr-2">${platformIcon}</span>
                                Available on ${movie.platform}
                            </span>
                        </div>
                    </div>

                    <!-- Details Section -->
                    <div class="swipe-card-details h-[calc(100%-240px)] overflow-y-auto p-4">
                        <div class="flex justify-between items-center mb-2">
                            <h2 class="text-2xl font-bold text-white truncate">${movie.title} (${movie.year})</h2>
                            <button onclick="showMovieDetailsModal('${movie.id}')" class="text-primary text-sm font-medium hover:text-orange-300" aria-label="More info about ${movie.title}">
                                More Info
                            </button>
                        </div>
                        <p class="text-sm text-gray-400 mb-3">${movie.genre} | ${movie.runtime}</p>
                        
                        <div class="bg-secondary p-3 rounded-lg border border-gray-700 mb-4">
                            <p class="text-sm text-gray-300 line-clamp-3">${movie.synopsis}</p>
                        </div>
                        
                        <p class="text-sm text-gray-400 mb-2">Trigger Warnings: <span class="text-red-400">${movie.trigger.join(', ')}</span></p>

                        <!-- Divider for cleaner mobile design -->
                         <div class="h-[1px] bg-gray-700 my-4"></div>
                        
                        <!-- AI Match Insight (Mocked) -->
                        <div class="bg-primary/20 p-3 rounded-lg border border-primary/50">
                            <p class="text-xs font-semibold text-primary mb-1">AI Match Insight:</p>
                            <p class="text-sm text-gray-300">Your preferences indicate a high likelihood of loving this film's theme (${movie.mood}).</p>
                        </div>
                    </div>
                </div>
            `;
        }


        function generateSwipeContent() {
            if (!window.isAuthReady) { /* ... loading content ... */ return '';} // Simplified check
            
            const movie = MOCK_SWIPE_MOVIES[currentMovieIndex];
            if (!movie) {
                 return `
                    <div class="p-8 text-center">
                        <h1 class="text-3xl font-extrabold text-white pt-2 mb-6">Queue Empty!</h1>
                        <p class="text-gray-400">You've reached the end of your current discovery queue. Adjust filters.</p>
                        <p class="mt-8 text-3xl">üçø sad popcorn</p>
                    </div>
                `;
            }

            const cardHtml = getSwipeCardHtml(movie);

            const pageHtml = `
                <div class="p-4 flex flex-col items-center justify-start min-h-[calc(100vh-64px-16px)]">
                    <h1 class="text-3xl font-extrabold text-white tracking-tight pt-2 mb-6">Find Your Next Movie</h1>

                    <!-- The Core Swipe Card -->
                    ${cardHtml}
                    
                    <!-- Swipe Action Buttons (4 Buttons) -->
                    <div class="flex justify-between space-x-2 w-full max-w-sm">
                        
                        <!-- NOPE Button (Red, Left) -->
                        <button data-action="pass" class="action-button swipe-action-button bg-nope text-white p-2 rounded-full hover:bg-red-500 flex-1 flex flex-col items-center" aria-label="No, thank you!">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                            <span class="text-xs mt-1">No, thank you !</span>
                        </button>

                         <!-- MAYBE Button (Yellow, Mid-Left) -->
                        <button data-action="maybe" class="action-button swipe-action-button bg-maybe text-secondary p-2 rounded-full hover:bg-yellow-400 flex-1 flex flex-col items-center" aria-label="Maybe, I'll watch later">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z" />
                            </svg>
                            <span class="text-xs mt-1">Maybe</span>
                        </button>

                        <!-- LIKE Button (Green, Mid-Right) -->
                        <button data-action="like" class="action-button swipe-action-button bg-like text-white p-2 rounded-full hover:bg-green-500 flex-1 flex flex-col items-center" aria-label="Like this movie">
                             <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.054-4.312 2.655-.715-1.601-2.377-2.655-4.313-2.655C4.099 3.75 2 5.765 2 8.25c0 7.22 9 12 10 12s10-4.78 10-12z" />
                            </svg>
                            <span class="text-xs mt-1">Like</span>
                        </button>
                        
                        <!-- LOVE Button (Blue, Right) -->
                        <button data-action="love" class="action-button swipe-action-button bg-love text-white p-2 rounded-full hover:bg-blue-500 flex-1 flex flex-col items-center border-4 border-blue-400/50" aria-label="Love this movie (Must Watch)">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" class="w-6 h-6">
                                <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
                            </svg>
                            <span class="text-xs mt-1">Love that !</span>
                        </button>
                    </div>

                    <p class="text-sm text-gray-500 mt-4">Drag the card or use the four buttons above.</p>
                </div>
            `;
            
            setTimeout(() => {
                setupSwipeGestureListeners(`movie-card-${movie.id}`);
                setupSwipeButtonListeners();
            }, 0); 
            
            return pageHtml;
        }

        function showMockNotification(message) {
            const existing = document.getElementById('mock-notification');
            if (existing) existing.remove();

            const notification = document.createElement('div');
            notification.id = 'mock-notification';
            notification.className = 'fixed bottom-20 left-1/2 transform -translate-x-1/2 bg-secondary text-white p-3 rounded-xl shadow-2xl border border-primary z-[100] text-sm opacity-0 transition-opacity duration-300';
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => { notification.style.opacity = 1; }, 50);
            setTimeout(() => { notification.style.opacity = 0; }, 1500);
            setTimeout(() => { notification.remove(); }, 1850);
        }

        function showUndoToast(movieTitle, action) {
            clearTimeout(toastTimeoutId);
            const existing = document.getElementById('undo-toast');
            if (existing) existing.remove();

            const toast = document.createElement('div');
            toast.id = 'undo-toast';
            toast.className = 'fixed bottom-20 left-1/2 transform -translate-x-1/2 w-11/12 max-w-sm bg-gray-800 text-white p-3 rounded-xl shadow-2xl border border-gray-700 z-[100] flex justify-between items-center opacity-0 transition-opacity duration-300';
            
            const message = `${action.toUpperCase()}: ${movieTitle}`;
            
            toast.innerHTML = `
                <span class="text-sm">${message}</span>
                <button id="undo-button"
                    class="bg-primary text-white text-xs font-bold py-1 px-3 rounded-lg hover:bg-orange-500 transition duration-150 ml-4"
                    aria-label="Undo last swipe action">
                    UNDO
                </button>
            `;
            
            document.body.appendChild(toast);
            
            document.getElementById('undo-button').addEventListener('click', window.undoLastSwipe);

            setTimeout(() => { toast.style.opacity = 1; }, 50);

            toastTimeoutId = setTimeout(() => {
                toast.style.opacity = 0;
                setTimeout(() => { toast.remove(); }, 300);
            }, 5000);
        }
        
        // --- Matches Logic (Points Based) ---
        function calculateMatchData(match) {
            const maxPossibleScore = match.totalMembers * 4; // Max score is 4 (Love that!)
            let actualScore = 0;
            let loveCount = 0;
            let likeCount = 0;

            match.swipes.forEach(swipe => {
                const score = SWIPE_SCORES[swipe.action] || 0;
                actualScore += score;
                if (swipe.action === 'love') loveCount++;
                if (swipe.action === 'like') likeCount++;
            });

            const matchPercentage = maxPossibleScore > 0 ? Math.round((actualScore / maxPossibleScore) * 100) : 0;
            
            return { matchPercentage, actualScore, maxPossibleScore, loveCount, likeCount };
        }

        function renderGroupMatches(selectedGroupName) {
            let matches = MOCK_GROUP_DATA_RANKED[selectedGroupName] || [];
            
            // 1. Calculate and sort matches by score (descending)
            matches = matches.map(match => {
                const data = calculateMatchData(match);
                return { ...match, ...data };
            }).sort((a, b) => b.matchPercentage - a.matchPercentage);

            // 2. Render cards
            const movieMatchCards = matches.map(match => {
                const { matchPercentage, loveCount, likeCount, status } = match;
                const progressColor = matchPercentage === 100 ? 'bg-love' : (matchPercentage >= 75 ? 'bg-like' : (matchPercentage >= 50 ? 'bg-maybe' : 'bg-nope'));
                const totalReactions = loveCount + likeCount;

                if (matchPercentage === 100) {
                    setTimeout(triggerConfetti, 150); 
                }

                return `
                    <div class="bg-card-bg p-4 rounded-xl border border-gray-700 shadow-lg transition hover:ring-2 ring-primary/50">
                        <div class="flex items-start justify-between mb-3">
                            <div>
                                <p class="text-lg font-bold text-white">${match.movie}</p>
                                <p class="text-sm text-gray-400">Platform: <span class="text-white font-medium">${match.platform}</span></p>
                                ${status ? `<p class="text-xs text-gray-500 mt-1">${status}</p>` : ''}
                            </div>
                            <div class="text-3xl font-extrabold ${matchPercentage === 100 ? 'text-love' : 'text-primary'}">
                                ${matchPercentage}%
                            </div>
                        </div>

                        <!-- Progress Bar for Group Consensus -->
                        <div class="mb-3">
                            <p class="text-xs text-gray-400 mb-1">Total Strong Reactions (Love/Like): ${totalReactions} / ${match.totalMembers}</p>
                            <div class="h-2 bg-gray-600 rounded-full overflow-hidden">
                                <div class="h-full ${progressColor} transition-all duration-500" style="width: ${matchPercentage}%"></div>
                            </div>
                        </div>
                        
                        <!-- Liked By Avatars -->
                        <div class="flex items-center mt-2">
                            <span class="text-sm text-gray-400 mr-3">Swipes:</span>
                            <div class="flex -space-x-2">
                                ${match.swipes.map(s => {
                                    let colorClass = 'bg-gray-500';
                                    if (s.action === 'love') colorClass = 'bg-love';
                                    else if (s.action === 'like') colorClass = 'bg-like';
                                    else if (s.action === 'maybe') colorClass = 'bg-maybe';
                                    
                                    return `
                                        <div class="h-6 w-6 rounded-full ${colorClass} border-2 border-card-bg flex items-center justify-center text-xs font-semibold text-white" 
                                             title="${s.user}: ${s.action.toUpperCase()}">
                                            ${s.user.charAt(0)}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                            ${matchPercentage === 100 ? '<span class="ml-3 text-lg perfect-match-icon" title="Perfect Match!">&#127881;</span>' : ''}
                        </div>
                    </div>
                `;
            }).join('');

            return `
                <h2 class="text-xl font-semibold text-white mb-4 mt-6">Matches for ${selectedGroupName}</h2>
                <p class="text-sm text-gray-500 mb-4">Ranked by hidden score: Love(4), Like(3), Maybe(1), Pass(0).</p>
                <div class="space-y-4">
                    ${movieMatchCards.length > 0 
                        ? movieMatchCards 
                        : `<p class="text-center text-gray-500 pt-4">No common matches found. Keep swiping!</p>`}
                </div>
            `;
        }


        function generateMatchesContent() {
            const groups = ["Alex K. (Couple)", "Sarah J. (Friend)", "The Squad (5 Members)"];
            
            const matchSelectors = groups.map((name, index) => {
                const isActive = index === 0 ? 'active-selection' : '';
                return `
                    <button data-match-name="${name}" class="match-selector flex-shrink-0 bg-primary/20 text-primary border border-primary hover:bg-primary hover:text-white font-medium py-2 px-4 rounded-full transition duration-150 ${isActive}" aria-label="Select match group: ${name}">
                        ${name}
                    </button>
                `;
            }).join('');

            return `
                <div class="p-4">
                    <h1 class="text-3xl font-extrabold text-white tracking-tight pt-2 mb-6">Group & Couple Matches</h1>
                    
                    <h2 class="text-lg font-medium text-white mb-3">Select Watch Group/Partner</h2>
                    <div id="match-selector-bar" class="flex overflow-x-auto pb-4 mb-6 space-x-3">
                        ${matchSelectors}
                    </div>

                    <div id="group-match-results">
                        ${renderGroupMatches("Alex K. (Couple)")} 
                    </div>
                </div>
            `;
        }
        
        function setupMatchSelectorListener() {
            const selectorBar = document.getElementById('match-selector-bar');
            const matchResultsArea = document.getElementById('group-match-results');

            if (selectorBar && matchResultsArea) {
                selectorBar.addEventListener('click', (e) => {
                    const selector = e.target.closest('.match-selector');
                    if (selector) {
                        const selectedName = selector.getAttribute('data-match-name');
                        document.querySelectorAll('.match-selector').forEach(btn => {
                            btn.classList.remove('active-selection');
                        });
                        selector.classList.add('active-selection');
                        matchResultsArea.innerHTML = renderGroupMatches(selectedName);
                    }
                });
            }
        }

        // --- Library Tab ---
        function generateLibraryContent() {
            const movieCards = MOCK_SWIPE_MOVIES.map(movie => {
                const { platformIcon, platformColor } = getPlatformStyle(movie.platform);
                return `
                    <div class="bg-card-bg rounded-xl shadow-lg border border-gray-700 cursor-pointer hover:shadow-xl transition flex" onclick="showMovieDetailsModal('${movie.id}')">
                        <img src="https://placehold.co/100x150/f97316/ffffff?text=P" onerror="this.onerror=null;this.src='https://placehold.co/100x150/f97316/ffffff?text=P';" 
                             alt="${movie.title} poster" class="w-24 h-36 object-cover rounded-l-xl flex-shrink-0">
                        <div class="p-3 flex-grow min-w-0">
                            <h3 class="text-lg font-bold text-white truncate">${movie.title} (${movie.year})</h3>
                            <p class="text-sm text-gray-400 mb-2">${movie.type} | ${movie.genre}</p>
                            <div class="flex items-center space-x-2 mb-2">
                                <span class="text-xs px-2 py-0.5 rounded-full bg-yellow-500 text-secondary font-bold">IMDb ${movie.imdb}</span>
                                <span class="text-xs px-2 py-0.5 rounded-full ${platformColor} text-white font-bold flex items-center">${platformIcon} ${movie.platform}</span>
                            </div>
                            <p class="text-xs text-gray-500 line-clamp-2">
                                ${movie.synopsis}
                            </p>
                        </div>
                    </div>
                `;
            }).join('');
            
            return `
                <div class="p-4">
                    <h1 class="text-3xl font-extrabold text-white tracking-tight pt-2 mb-6">Full Movie Library</h1>
                    <p class="text-gray-400 mb-6">${MOCK_SWIPE_MOVIES.length} titles available in your regions.</p>
                    
                    <!-- Mock Search/Filter Bar -->
                    <div class="mb-6">
                        <input type="text" placeholder="Search by title, actor, or genre..." class="w-full p-3 rounded-lg bg-secondary text-white border border-gray-700 focus:ring-primary focus:border-primary">
                    </div>

                    <div class="space-y-4">
                        ${movieCards}
                    </div>
                </div>
            `;
        }


        // --- Profile Tab ---

        function generateProfileContent() {
             const platformList = MOCK_PLATFORMS.map(p => `
                <div class="flex justify-between items-center py-3 border-b border-gray-700 last:border-b-0">
                    <div class="flex items-center space-x-3">
                        <div class="h-8 w-8 rounded-full bg-card-bg border-2 border-gray-600 flex items-center justify-center text-lg font-bold ${p.color}">${p.icon}</div>
                        <span class="text-gray-200">${p.name}</span>
                    </div>
                    <button class="text-sm font-medium px-3 py-1 rounded-full 
                        ${p.status === 'Connected' 
                            ? 'bg-red-600 text-white hover:bg-red-700' 
                            : 'bg-primary text-white hover:bg-orange-500'}" aria-label="${p.status === 'Connected' ? 'Disconnect' : 'Connect'} ${p.name}">
                        ${p.status === 'Connected' ? 'Disconnect' : 'Connect'}
                    </button>
                </div>
            `).join('');

            const warningSettings = MOCK_SWIPE_MOVIES.reduce((acc, movie) => {
                movie.trigger.forEach(trigger => {
                    if (!acc.has(trigger)) {
                        acc.add(trigger);
                    }
                });
                return acc;
            }, new Set());
            
            const warningHtml = Array.from(warningSettings).map(w => `
                <div class="flex justify-between items-center py-3 border-b border-gray-700 last:border-b-0">
                    <span class="text-gray-200">${w}</span>
                    <label class="toggle-switch">
                        <input type="checkbox" data-setting-label="${w}" class="setting-toggle" ${w === 'High Violence' || w === 'Emotional Loss' ? 'checked' : ''}>
                        <span class="slider"></span>
                    </label>
                </div>
            `).join('');

            // Helper for the toggle switch in Profile
            const darkModeToggleHtml = `
                <div class="flex justify-between items-center py-3">
                    <span class="text-gray-200">Dark Mode</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="dark-mode-toggle" onchange="toggleTheme()" ${isDarkMode ? 'checked' : ''}>
                        <span class="slider"></span>
                    </label>
                </div>
            `;

            return `
                <div class="p-4">
                    <h1 class="text-3xl font-extrabold text-white tracking-tight pt-2 mb-6">My Profile & Settings</h1>
                    
                    <div class="bg-card-bg rounded-xl p-6 text-center shadow-xl mb-8">
                        <img src="https://placehold.co/100x100/f97316/ffffff?text=U" alt="Profile Avatar" class="w-24 h-24 rounded-full mx-auto border-4 border-primary mb-4">
                        <h2 class="text-2xl font-bold text-white">Movie Enthusiast</h2>
                        <p class="text-sm text-gray-400">XP Level 14 | Horror Duo Badge</p>
                        <code class="block bg-gray-800 text-green-400 p-2 rounded-lg text-xs break-all mt-4">${window.userId || 'Loading...'}</code>
                    </div>
                    
                    <!-- Add Friend -->
                    <div class="bg-secondary rounded-xl p-4 shadow-xl mb-8 border border-gray-700">
                        <h2 class="text-xl font-semibold text-white mb-3">Add Friend</h2>
                        <input type="text" placeholder="Enter Friend's User ID..." class="w-full p-3 rounded-lg bg-gray-800 text-white border border-gray-700 mb-3">
                        <button class="w-full bg-primary text-white font-bold py-2 rounded-lg hover:bg-orange-500 transition" aria-label="Send friend request">
                            Send Request
                        </button>
                    </div>

                    <h2 class="text-xl font-semibold text-white mb-4">Associated Platforms</h2>
                    <div class="bg-secondary rounded-xl p-4 shadow-xl mb-8 border border-gray-700">
                        ${platformList}
                    </div>

                    <h2 class="text-xl font-semibold text-white mb-4">Trigger Warning Setup</h2>
                    <p class="text-sm text-gray-400 mb-4">Toggle sensitive topics you wish to filter.</p>
                    <div id="warning-settings-list" class="bg-secondary rounded-xl p-4 shadow-xl mb-8 border border-gray-700">
                        ${warningHtml}
                    </div>

                    <h2 class="text-xl font-semibold text-white mb-4">App Preferences</h2>
                    <div class="bg-secondary rounded-xl p-4 shadow-xl mb-8 border border-gray-700">
                        ${darkModeToggleHtml}
                        <div class="flex justify-between items-center py-3 border-t border-gray-700">
                            <span class="text-gray-200">Language:</span>
                            <select class="bg-card-bg text-white p-2 rounded-lg border border-gray-600">
                                <option>English (US)</option>
                                <option>Fran√ßais (FR)</option>
                                <option>Espa√±ol (ES)</option>
                            </select>
                        </div>
                         <div class="flex justify-between items-center py-3 border-t border-gray-700">
                            <span class="text-gray-200">Location:</span>
                            <select class="bg-card-bg text-white p-2 rounded-lg border border-gray-600">
                                <option>United States</option>
                                <option>Canada</option>
                                <option>France</option>
                            </select>
                        </div>
                    </div>
                    

                    <button class="w-full bg-red-600 text-white font-bold py-3 rounded-lg hover:bg-red-700 transition shadow-lg" aria-label="Log out of the application">
                        Log Out
                    </button>
                </div>
            `;
        }
        
        function setupProfileListeners() {
            // Re-attach listeners for dynamically loaded content if needed
            // The dark mode toggle uses an inline function call: onchange="toggleTheme()"
            // Trigger warning toggles can be added here if they were dynamic
        }

        // --- Tab Control ---
        const navItems = document.querySelectorAll('.nav-item');
        navItems.forEach(item => {
            item.addEventListener('click', () => {
                const tabName = item.getAttribute('data-tab');
                setActiveTab(tabName);
            });
        });

        function setActiveTab(tabName) {
            const contentArea = document.getElementById('content-area');
            const navItems = document.querySelectorAll('.nav-item');
            
            navItems.forEach(item => {
                const isActive = item.getAttribute('data-tab') === tabName;
                item.classList.toggle('active', isActive);
                item.classList.toggle('text-primary', isActive);
                item.classList.toggle('text-gray-400', !isActive);
            });

            switch (tabName) {
                case 'home':
                    contentArea.innerHTML = generateHomeContent();
                    break;
                case 'library':
                    contentArea.innerHTML = generateLibraryContent();
                    break;
                case 'swipe':
                    contentArea.innerHTML = generateSwipeContent();
                    break;
                case 'matches':
                    contentArea.innerHTML = generateMatchesContent();
                    setupMatchSelectorListener();
                    break;
                case 'profile':
                    contentArea.innerHTML = generateProfileContent();
                    setupProfileListeners();
                    break;
                default:
                    contentArea.innerHTML = `<div class="p-4 text-center text-gray-500">Page not found.</div>`;
            }
        }
        
        window.initializeAppContent = () => {
             setActiveTab('home'); // Change default to Home tab
        };

        window.onload = () => {
             window.setupFirebase();
        };
    </script>
</body>
</html>
